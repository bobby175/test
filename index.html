<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png">
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chat Online">
    <link rel="apple-touch-icon" href="icon.png">
    
    <style>
        /* [KEEP ALL STYLES SAME] */
        /* ... existing styles ... */
        
        /* Mobile-specific fixes */
        @media (max-width: 768px) {
            .container {
                padding: 8px;
                height: 100vh;
            }
            
            textarea {
                min-height: 50px;
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            #sendBtn {
                padding: 14px;
                font-size: 16px;
            }
            
            .bubble {
                max-width: 85%;
                font-size: 15px;
            }
            
            /* Fix for iOS Safari */
            input, textarea {
                -webkit-appearance: none;
                border-radius: 20px;
            }
        }
        
        /* Fix untuk notifikasi */
        .notification-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>

<body>
    <!-- Notification Badge untuk Mobile -->
    <div class="notification-badge" id="notificationBadge">!</div>
    
    <div class="container">
        <h1>ðŸ’¬ Chat Online</h1>
        <input id="userName" placeholder="Masukkan nama kamu" autocomplete="off">
        
        <div class="toggles">
            <label class="toggle">
                <input type="checkbox" id="enterSend"> Enter untuk kirim
            </label>
            <label class="toggle">
                <input type="checkbox" id="notifToggle"> Notifikasi
            </label>
        </div>
        
        <div class="chat" id="chat"></div>
        
        <textarea id="input" placeholder="Tulis pesan..." autocomplete="off"></textarea>
        <button id="sendBtn" disabled>Kirim</button>
        
        <div class="credit">Dibuat oleh A.M. | Chat online realtime</div>
    </div>
    
    <!-- Audio untuk semua platform -->
    <audio id="notifSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" type="audio/mpeg">
        <source src="notification.mp3" type="audio/mpeg">
    </audio>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import {
            getFirestore, collection, addDoc,
            serverTimestamp, onSnapshot,
            query, orderBy, limit, Timestamp
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCWS4rKfiuFKe-nISBKa8ctrwDt7jbSTM",
            authDomain: "note-ad793.firebaseapp.com",
            projectId: "note-ad793",
            storageBucket: "note-ad793.appspot.com",
            messagingSenderId: "932514166408",
            appId: "1:932514166408:web:bba048952443b58f14113d"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Elemen DOM
        const chatEl = document.getElementById("chat");
        const input = document.getElementById("input");
        const nameInput = document.getElementById("userName");
        const sendBtn = document.getElementById("sendBtn");
        const enterToggle = document.getElementById("enterSend");
        const notifToggle = document.getElementById("notifToggle");
        const notifSound = document.getElementById("notifSound");
        const notificationBadge = document.getElementById("notificationBadge");
        
        // Variabel
        let lastSeen = Number(localStorage.getItem("lastSeen") || 0);
        let isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        let appVisible = true;
        
        console.log("Device Info:", { isMobile, isIOS, isSafari });
        
        // ====================== SERVICE WORKER REGISTRATION ======================
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('Service Worker registered:', registration.scope);
                    
                    // Cek jika service worker aktif
                    if (registration.active) {
                        console.log('Service Worker aktif');
                    }
                    
                    return registration;
                } catch (error) {
                    console.log('Service Worker registration failed:', error);
                    return null;
                }
            }
            return null;
        }
        
        // ====================== NOTIFICATION PERMISSION ======================
        async function requestNotificationPermission() {
            // Cek apakah browser mendukung notifikasi
            if (!('Notification' in window)) {
                console.log('Browser tidak mendukung notifikasi');
                return false;
            }
            
            // Jika sudah diizinkan
            if (Notification.permission === 'granted') {
                return true;
            }
            
            // Jika belum ditanyakan, minta izin
            if (Notification.permission !== 'denied') {
                try {
                    // Untuk iOS/Safari, harus dari user interaction
                    const permission = await Notification.requestPermission();
                    console.log('Permission status:', permission);
                    return permission === 'granted';
                } catch (error) {
                    console.log('Error requesting permission:', error);
                    return false;
                }
            }
            
            return false;
        }
        
        // ====================== PLAY NOTIFICATION SOUND ======================
        function playNotificationSound() {
            if (!notifToggle.checked) return;
            
            // Untuk mobile, butuh user interaction terlebih dahulu
            try {
                notifSound.currentTime = 0;
                
                // Unmute audio
                notifSound.muted = false;
                notifSound.volume = 0.7;
                
                const playPromise = notifSound.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Audio play failed:', error);
                        // Coba dengan user gesture
                        document.addEventListener('click', function playOnClick() {
                            notifSound.play().catch(e => console.log('Still failed:', e));
                            document.removeEventListener('click', playOnClick);
                        }, { once: true });
                    });
                }
            } catch (error) {
                console.log('Error playing sound:', error);
            }
        }
        
        // ====================== SHOW NOTIFICATION ======================
        async function showNotification(title, body) {
            if (!notifToggle.checked) return;
            
            // Cek izin
            if (Notification.permission !== 'granted') {
                return;
            }
            
            // Cek jika app tidak visible (background/minimized)
            if (!appVisible) {
                // Tampilkan badge untuk mobile
                if (isMobile) {
                    notificationBadge.style.display = 'flex';
                    notificationBadge.textContent = 'ðŸ’¬';
                    
                    // Auto hide setelah 5 detik
                    setTimeout(() => {
                        notificationBadge.style.display = 'none';
                    }, 5000);
                }
                
                // Mainkan suara
                playNotificationSound();
                
                // Coba tampilkan notifikasi browser
                try {
                    const options = {
                        body: body,
                        icon: 'icon.png',
                        badge: 'icon.png',
                        tag: 'chat-message',
                        requireInteraction: false,
                        vibrate: isMobile ? [200, 100, 200] : undefined
                    };
                    
                    // Untuk iOS, gunakan service worker jika ada
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'SHOW_NOTIFICATION',
                            notification: {
                                title: title,
                                options: options
                            }
                        });
                    } else {
                        // Fallback ke Notification API
                        const notification = new Notification(title, options);
                        
                        notification.onclick = function() {
                            window.focus();
                            this.close();
                        };
                    }
                } catch (error) {
                    console.log('Notification error:', error);
                }
            } else {
                // App visible, hanya mainkan suara
                playNotificationSound();
            }
        }
        
        // ====================== VISIBILITY CHANGE ======================
        document.addEventListener('visibilitychange', () => {
            appVisible = !document.hidden;
            console.log('App visible:', appVisible);
            
            if (appVisible) {
                // Sembunyikan badge jika ada
                notificationBadge.style.display = 'none';
                
                // Update last seen
                lastSeen = Date.now();
                localStorage.setItem('lastSeen', lastSeen);
            }
        });
        
        // ====================== INITIAL SETUP ======================
        // Register service worker
        registerServiceWorker();
        
        // Load saved settings
        const SAVED_NAME = localStorage.getItem("myName");
        if (SAVED_NAME) {
            nameInput.value = SAVED_NAME;
            nameInput.disabled = true;
            sendBtn.disabled = false;
        }
        
        // Load toggle states
        enterToggle.checked = localStorage.getItem("enterSend") !== null
            ? localStorage.getItem("enterSend") === "true"
            : !isMobile;
            
        notifToggle.checked = localStorage.getItem("notifOn") === "true";
        
        // Setup toggle listeners
        enterToggle.onchange = () => {
            localStorage.setItem("enterSend", enterToggle.checked);
        };
        
        notifToggle.onchange = async () => {
            const isChecked = notifToggle.checked;
            localStorage.setItem("notifOn", isChecked);
            
            if (isChecked) {
                const granted = await requestNotificationPermission();
                if (!granted) {
                    notifToggle.checked = false;
                    localStorage.setItem("notifOn", false);
                    
                    // Tampilkan alert friendly
                    if (isMobile) {
                        alert('Untuk notifikasi, silakan:\n1. Izinkan notifikasi di pengaturan browser\n2. Tambahkan ke home screen untuk pengalaman terbaik');
                    }
                }
            }
        };
        
        // Auto-enable notifications untuk iOS jika di home screen
        if (isIOS && window.navigator.standalone) {
            notifToggle.checked = true;
            localStorage.setItem("notifOn", true);
            requestNotificationPermission();
        }
        
        // ====================== CHAT FUNCTIONS ======================
        nameInput.addEventListener("input", () => {
            sendBtn.disabled = !nameInput.value.trim();
        });
        
        function colorFromName(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `hsl(${Math.abs(hash) % 360}, 65%, 35%)`;
        }
        
        function formatTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'baru saja';
            if (diffMins < 60) return `${diffMins} menit lalu`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)} jam lalu`;
            
            return date.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                day: 'numeric',
                month: 'short'
            });
        }
        
        // ====================== FIREBASE LISTENER ======================
        const q = query(
            collection(db, "notes"),
            orderBy("createdAt", "desc"),
            limit(100)
        );
        
        let firstLoad = true;
        let lastMessageTime = 0;
        
        onSnapshot(q, { includeMetadataChanges: true }, snap => {
            if (firstLoad) {
                snap.forEach(d => {
                    const data = d.data();
                    if (data.createdAt) {
                        lastSeen = Math.max(lastSeen, data.createdAt.toMillis());
                    }
                });
                localStorage.setItem("lastSeen", lastSeen);
                firstLoad = false;
            }
            
            // Process new messages
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    if (!data.createdAt) return;
                    
                    const ts = data.createdAt.toMillis();
                    const myName = nameInput.value || "";
                    
                    // Cek jika pesan baru (lebih dari 2 detik untuk avoid double)
                    if (ts > lastSeen && (Date.now() - lastMessageTime > 2000)) {
                        lastMessageTime = Date.now();
                        
                        if (data.name !== myName) {
                            // Tampilkan notifikasi
                            showNotification(
                                `${data.name} mengirim pesan`,
                                data.text.length > 50 ? data.text.substring(0, 50) + '...' : data.text
                            );
                        }
                        
                        lastSeen = ts;
                        localStorage.setItem("lastSeen", lastSeen);
                    }
                }
            });
            
            // Render messages
            chatEl.innerHTML = "";
            const messages = [];
            
            snap.forEach(d => {
                messages.push(d.data());
            });
            
            messages.reverse().forEach(data => {
                if (!data.createdAt) return;
                
                const div = document.createElement("div");
                const isMe = data.name === (nameInput.value || "");
                
                if (isMe) {
                    div.className = "bubble right";
                } else {
                    div.className = "bubble left";
                    const c = colorFromName(data.name || "Anonim");
                    div.style.background = c;
                    div.style.setProperty("--c", c);
                }
                
                div.innerHTML = `
                    <div class="meta">
                        <span class="name">${data.name || "Anonim"}</span>
                        <span class="time">${formatTime(data.createdAt.toDate())}</span>
                    </div>
                    <div>${data.text.replace(/\n/g, '<br>')}</div>
                `;
                chatEl.appendChild(div);
            });
            
            chatEl.scrollTop = chatEl.scrollHeight;
        });
        
        // ====================== SEND MESSAGE ======================
        async function sendMessage() {
            const name = nameInput.value.trim();
            const text = input.value.trim();
            
            if (!name || !text) return;
            
            // Simpan nama
            localStorage.setItem("myName", name);
            nameInput.disabled = true;
            sendBtn.disabled = false;
            
            try {
                await addDoc(collection(db, "notes"), {
                    name: name,
                    text: text,
                    createdAt: serverTimestamp()
                });
                
                input.value = "";
                input.style.height = 'auto';
                input.focus();
            } catch (error) {
                console.error("Error mengirim pesan:", error);
                alert("Gagal mengirim pesan. Periksa koneksi internet.");
            }
        }
        
        // ====================== EVENT LISTENERS ======================
        sendBtn.onclick = sendMessage;
        
        input.onkeydown = e => {
            if (e.key === "Enter" && !e.shiftKey && enterToggle.checked) {
                e.preventDefault();
                sendMessage();
            }
        };
        
        // Auto-resize textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
        
        // ====================== MOBILE SPECIFIC FIXES ======================
        // Fix untuk iOS keyboard
        if (isIOS) {
            const originalHeight = window.innerHeight;
            
            window.addEventListener('resize', () => {
                if (window.innerHeight < originalHeight) {
                    // Keyboard muncul, scroll ke input
                    setTimeout(() => {
                        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });
        }
        
        // Touch feedback untuk mobile
        sendBtn.addEventListener('touchstart', () => {
            sendBtn.style.opacity = '0.8';
        });
        
        sendBtn.addEventListener('touchend', () => {
            sendBtn.style.opacity = '1';
        });
        
        // Force user interaction untuk audio di iOS
        if (isIOS) {
            document.addEventListener('touchstart', function initAudio() {
                notifSound.volume = 0.0001;
                notifSound.play().then(() => {
                    notifSound.pause();
                    notifSound.currentTime = 0;
                }).catch(() => {});
                document.removeEventListener('touchstart', initAudio);
            }, { once: true });
        }
        
        // ====================== APP INSTALL PROMPT ======================
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Tampilkan install button untuk mobile
            if (isMobile) {
                setTimeout(() => {
                    if (confirm('Ingin install aplikasi Chat untuk notifikasi yang lebih baik?')) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('User installed the app');
                            }
                            deferredPrompt = null;
                        });
                    }
                }, 3000);
            }
        });
        
        // Inisialisasi notifikasi jika toggle aktif
        if (notifToggle.checked) {
            setTimeout(() => requestNotificationPermission(), 1000);
        }
        
        console.log('Chat app initialized successfully');
    </script>
</body>
</html>
