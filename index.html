<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png">
    
    <style>
        html, body {
            margin: 0;
            height: 100%;
            background: #0f0f14;
            font-family: system-ui, Segoe UI, Arial;
            color: #fff;
            overflow-x: hidden;
            touch-action: pan-y;
            overscroll-behavior-x: none;
        }
        
        .container {
            max-width: 700px;
            height: 100%;
            margin: auto;
            display: flex;
            flex-direction: column;
            padding: 12px;
        }
        
        h1 {
            text-align: center;
            color: #00e0ff;
            margin: 6px 0;
        }
        
        #userName {
            padding: 8px;
            border-radius: 8px;
            border: none;
            margin-bottom: 6px;
            background: #1c1c25;
            color: white;
        }
        
        #userName:disabled {
            opacity: .6;
            background: #1a1a22;
        }
        
        .toggles {
            display: flex;
            gap: 14px;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .toggle {
            font-size: 12px;
            opacity: .85;
        }
        
        .toggle input {
            accent-color: #25d366;
        }
        
        .chat {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 6px 4px;
        }
        
        .bubble {
            max-width: 78%;
            width: fit-content;
            padding: 8px 10px 10px;
            border-radius: 8px;
            position: relative;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .left {
            align-self: flex-start;
            border-top-left-radius: 0;
        }
        
        .right {
            align-self: flex-end;
            background: #075e54;
            border-top-right-radius: 0;
        }
        
        .left::before {
            content: "";
            position: absolute;
            left: -6px;
            top: 0;
            border-width: 6px 6px 0 0;
            border-style: solid;
            border-color: var(--c) transparent transparent transparent;
        }
        
        .meta {
            display: flex;
            gap: 6px;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .name {
            font-weight: 700;
            filter: brightness(1.35);
        }
        
        .time {
            font-size: 10px;
            opacity: .6;
        }
        
        textarea {
            min-height: 60px;
            border-radius: 20px;
            border: none;
            padding: 10px;
            resize: none;
            background: #1c1c25;
            color: #fff;
            font-family: inherit;
        }
        
        button {
            margin-top: 6px;
            padding: 12px;
            border: none;
            border-radius: 20px;
            background: #25d366;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            opacity: .4;
            cursor: not-allowed;
        }
        
        .credit {
            text-align: center;
            font-size: 11px;
            opacity: .5;
            margin-top: 6px;
        }
        
        /* Scrollbar styling */
        .chat::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat::-webkit-scrollbar-track {
            background: #1a1a22;
            border-radius: 4px;
        }
        
        .chat::-webkit-scrollbar-thumb {
            background: #25d366;
            border-radius: 4px;
        }
        
        /* Loading animation */
        .typing {
            display: inline-block;
        }
        
        .typing span {
            height: 8px;
            width: 8px;
            background: #25d366;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }
        
        .typing span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ðŸ’¬ Chat Online</h1>
        <input id="userName" placeholder="Masukkan nama kamu">
        
        <div class="toggles">
            <label class="toggle">
                <input type="checkbox" id="enterSend"> Enter untuk kirim
            </label>
            <label class="toggle">
                <input type="checkbox" id="notifToggle"> Notifikasi
            </label>
        </div>
        
        <div class="chat" id="chat"></div>
        
        <textarea id="input" placeholder="Tulis pesan..."></textarea>
        <button id="sendBtn" disabled>Kirim</button>
        
        <div class="credit">Dibuat oleh A.M. | Chat online realtime</div>
    </div>
    
    <audio id="notifSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" type="audio/mpeg">
    </audio>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
        import {
            getFirestore, collection, addDoc,
            serverTimestamp, onSnapshot,
            query, orderBy, limit
        } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
        
        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCWS4rKfiuFKe-nISBKa8ctrwDt7jbSTM",
            authDomain: "note-ad793.firebaseapp.com",
            projectId: "note-ad793",
            storageBucket: "note-ad793.appspot.com",
            messagingSenderId: "932514166408",
            appId: "1:932514166408:web:bba048952443b58f14113d"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Elemen DOM
        const chatEl = document.getElementById("chat");
        const input = document.getElementById("input");
        const nameInput = document.getElementById("userName");
        const sendBtn = document.getElementById("sendBtn");
        const enterToggle = document.getElementById("enterSend");
        const notifToggle = document.getElementById("notifToggle");
        const notifSound = document.getElementById("notifSound");
        
        // Variabel
        let lastSeen = Number(localStorage.getItem("lastSeen") || 0);
        let messageCount = 0;
        
        // Daftarkan Service Worker untuk notifikasi
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('Service Worker berhasil didaftarkan');
                })
                .catch(err => {
                    console.log('Service Worker gagal didaftarkan:', err);
                });
        }
        
        // Minta izin notifikasi
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Browser tidak mendukung notifikasi');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            
            return false;
        }
        
        // Tampilkan notifikasi
        function showNotification(title, body) {
            if (!notifToggle.checked) return;
            if (Notification.permission !== 'granted') return;
            
            // Jika tab aktif, mainkan suara
            if (!document.hidden) {
                notifSound.currentTime = 0;
                notifSound.play().catch(() => {});
            }
            
            // Tampilkan notifikasi
            const notification = new Notification(title, {
                body: body,
                icon: 'icon.png',
                badge: 'icon.png',
                tag: 'chat-message',
                requireInteraction: false,
                silent: document.hidden // Hanya diam jika tab tidak aktif
            });
            
            // Saat notifikasi diklik, fokus ke window
            notification.onclick = function() {
                window.focus();
                notification.close();
            };
            
            // Tutup notifikasi otomatis setelah 5 detik
            setTimeout(() => notification.close(), 5000);
        }
        
        // Restore data dari localStorage
        const SAVED_NAME = localStorage.getItem("myName");
        if (SAVED_NAME) {
            nameInput.value = SAVED_NAME;
            nameInput.disabled = true;
            sendBtn.disabled = false;
        }
        
        // Cek apakah perangkat mobile
        const isMobile = /android|iphone|ipad/i.test(navigator.userAgent);
        
        // Load pengaturan
        enterToggle.checked = localStorage.getItem("enterSend") !== null
            ? localStorage.getItem("enterSend") === "true"
            : !isMobile;
            
        notifToggle.checked = localStorage.getItem("notifOn") === "true";
        
        // Event listeners untuk toggle
        enterToggle.onchange = () => {
            localStorage.setItem("enterSend", enterToggle.checked);
        };
        
        notifToggle.onchange = async () => {
            localStorage.setItem("notifOn", notifToggle.checked);
            if (notifToggle.checked) {
                const granted = await requestNotificationPermission();
                if (!granted) {
                    notifToggle.checked = false;
                    localStorage.setItem("notifOn", false);
                    alert('Izinkan notifikasi untuk mendapatkan pemberitahuan pesan baru');
                }
            }
        };
        
        // Event listener untuk nama
        nameInput.addEventListener("input", () => {
            sendBtn.disabled = !nameInput.value.trim();
        });
        
        // Generate warna dari nama
        function colorFromName(name) {
            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `hsl(${Math.abs(hash) % 360}, 65%, 35%)`;
        }
        
        // Format waktu
        function formatTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'baru saja';
            if (diffMins < 60) return `${diffMins} menit lalu`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)} jam lalu`;
            
            return date.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit',
                day: 'numeric',
                month: 'short'
            });
        }
        
        // Query Firestore
        const q = query(
            collection(db, "notes"),
            orderBy("createdAt", "desc"),
            limit(100)
        );
        
        let firstLoad = true;
        
        // Listen untuk perubahan data
        onSnapshot(q, { includeMetadataChanges: true }, snap => {
            // Update lastSeen pada first load
            if (firstLoad) {
                snap.forEach(d => {
                    const data = d.data();
                    if (data.createdAt) {
                        lastSeen = Math.max(lastSeen, data.createdAt.toMillis());
                    }
                });
                localStorage.setItem("lastSeen", lastSeen);
                firstLoad = false;
            }
            
            // Proses pesan baru
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    if (!data.createdAt) return;
                    
                    const ts = data.createdAt.toMillis();
                    const myName = nameInput.value || "";
                    
                    // Cek jika pesan baru dan bukan dari user sendiri
                    if (ts > lastSeen) {
                        if (data.name !== myName) {
                            // Tampilkan notifikasi jika tab tidak aktif atau browser minimized
                            if (document.hidden) {
                                showNotification(`${data.name} mengirim pesan`, data.text);
                            } else if (notifToggle.checked) {
                                // Tab aktif, mainkan suara saja
                                notifSound.currentTime = 0;
                                notifSound.play().catch(() => {});
                            }
                        }
                        lastSeen = ts;
                        localStorage.setItem("lastSeen", lastSeen);
                    }
                }
            });
            
            // Render semua pesan
            chatEl.innerHTML = "";
            const messages = [];
            
            snap.forEach(d => {
                messages.push(d.data());
            });
            
            // Urutkan dari terlama ke terbaru untuk ditampilkan
            messages.reverse().forEach(data => {
                if (!data.createdAt) return;
                
                const div = document.createElement("div");
                const isMe = data.name === (nameInput.value || "");
                
                if (isMe) {
                    div.className = "bubble right";
                } else {
                    div.className = "bubble left";
                    const c = colorFromName(data.name || "Anonim");
                    div.style.background = c;
                    div.style.setProperty("--c", c);
                }
                
                div.innerHTML = `
                    <div class="meta">
                        <span class="name">${data.name || "Anonim"}</span>
                        <span class="time">${formatTime(data.createdAt.toDate())}</span>
                    </div>
                    <div>${data.text.replace(/\n/g, '<br>')}</div>
                `;
                chatEl.appendChild(div);
            });
            
            // Scroll ke bawah
            chatEl.scrollTop = chatEl.scrollHeight;
        });
        
        // Kirim pesan
        async function sendMessage() {
            const name = nameInput.value.trim();
            const text = input.value.trim();
            
            if (!name || !text) return;
            
            // Simpan nama ke localStorage
            localStorage.setItem("myName", name);
            nameInput.disabled = true;
            sendBtn.disabled = false;
            
            try {
                await addDoc(collection(db, "notes"), {
                    name: name,
                    text: text,
                    createdAt: serverTimestamp()
                });
                
                input.value = "";
                input.focus();
            } catch (error) {
                console.error("Error mengirim pesan:", error);
                alert("Gagal mengirim pesan. Coba lagi.");
            }
        }
        
        // Event listeners
        sendBtn.onclick = sendMessage;
        
        input.onkeydown = e => {
            if (e.key === "Enter" && !e.shiftKey && enterToggle.checked) {
                e.preventDefault();
                sendMessage();
            }
        };
        
        // Auto-resize textarea
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // Deteksi ketika tab/window tidak aktif
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Tab tidak aktif, simpan waktu
                localStorage.setItem('lastActive', Date.now());
            } else {
                // Tab aktif lagi, update lastSeen
                lastSeen = Date.now();
                localStorage.setItem('lastSeen', lastSeen);
            }
        });
        
        // Deteksi sebelum tab ditutup
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('tabClosedAt', Date.now());
        });
        
        // Cek apakah ada notifikasi yang tertunda saat halaman dimuat
        window.addEventListener('load', () => {
            const lastActive = localStorage.getItem('lastActive');
            const tabClosedAt = localStorage.getItem('tabClosedAt');
            
            if (lastActive && tabClosedAt) {
                const timeDiff = Date.now() - Math.max(lastActive, tabClosedAt);
                
                // Jika user kembali setelah > 10 detik, anggap sebagai "kembali dari tidak aktif"
                if (timeDiff > 10000 && notifToggle.checked) {
                    // Di sini bisa tambahkan logika untuk mengecek pesan baru
                    // atau menampilkan welcome back message
                }
            }
        });
        
        // Inisialisasi notifikasi jika toggle aktif
        if (notifToggle.checked) {
            requestNotificationPermission();
        }
    </script>
</body>
</html>
